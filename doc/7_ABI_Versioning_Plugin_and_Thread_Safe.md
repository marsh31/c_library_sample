# ABI・バージョニング・プラグイン・スレッドセーフ

## ABI 安定性とバージョニング

- ABI (Application Binary Interface) とは：
  - 関数のシグネチャ、データ構造のサイズ・レイアウト、呼び出し規約など。

- 共有ライブラリはABIが変わると、古い実行ファイルが動かなくなることがある。

- 対応策：
  - 構造体に末尾にフィールドを追加する（途中に挟まない）などのルール。
  - SONAME を上げるタイミングの設計。


## シンボルの可視性

- `__attribute__((visibility("hidden")))`

- 不要な内部シンボルを外から見えないようにしてABIを安定させる。

- `-fvisibility=hidden` と `__attribute__((visibility("default")))` の組み合わせ。


## 動的ロード（プラグイン方式）

- `dlopen`, `dlsym`, `dlclose`（`<dlfcn.h>`）
  - 実行中にプラグイン `.so` を読み込んで関数ポインタを取得。

- プラグイン API を設計するときのポイント：
  - バージョン番号を持たせる
  - 入口関数を一つにまとめる（例：`plugin_init()`）


## スレッドセーフ性・再入可能性

- グローバル変数をどう扱うか
- `errno`・`strerror` などのスレッドセーフ版
- ライブラリ内部でのロックの設計

